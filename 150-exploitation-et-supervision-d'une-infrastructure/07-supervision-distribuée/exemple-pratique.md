# TP – Supervision distribuée avec Centreon
## 🧾 Contexte et architecture

L’entreprise **PcP (Programmeurs en C Plus-plus)** subit des instabilités de service. Votre mission consiste à :

- Intégrer leur poller Centreon à votre infrastructure centrale
- Superviser les services internes critiques : DNS, HTTP, Samba, NFS
- Utiliser Centreon pour configurer une supervision distribuée stable, évolutive et réutilisable

### Schéma logique (machines clientes)

- `ClientPCP-FIREWALL` (pfSense) – IP publique accessible
- `ClientPCP-SRVDMZ` (Web + DNS)
- `ClientPCP-SRVFIC` (Samba + NFS)
- `PollerPCP` – installé dans leur réseau, accessible en SSH

Compte de maintenance sur les serveurs clients : `presta / Pa$$w0rd`

---

## 🔄 Étape 1 – Ajout du poller distant (PollerPCP)

### 1. Génération de la clé SSH côté central

```bash
su - centreon-gorgone
ssh-keygen -t rsa     # Valider sans passphrase
```

### 2. Copie de la clé vers le poller

```bash
ssh-copy-id centreon@192.168.1.10
```

### 3. Vérification de la connexion

```bash
ssh centreon@192.168.1.10     # Pas de mot de passe demandé
```

### 4. Ajout via l’interface Web

- **Configuration > Pollers > Add Server with wizard**
- Mode de communication : SSH
- Vérifier :
    - Lancement des services
    - Redémarrage du poller (au besoin 2 fois)

### 5. Redémarrer le Gorgone côté central

```bash
systemctl restart gorgoned
```

---

## 🧠 Étape 2 – Analyse des services à superviser

|Hôte|Superviseur|Services supervisés|
|---|---|---|
|`SRV-DMZ`|PollerPCP|HTTP sur `www.pcp.local`, DNS `pcp.local` + `pcp.fr`|
|`SRV-FIC`|PollerPCP|Samba (admin, distrib), NFS|
|`pfSensePCP`|Central|HTTP (port 8080), NAT `www.pcp.fr`|

> 💡 Vérifier les plugins disponibles : `check_http`, `check_dns`, `check_rpc`, `check_disk_smb`, `check_ping`  
> Si besoin, copier avec `scp` depuis le central

---

## 🛠️ Étape 3 – Commandes de supervision (réutilisables)
### 📌 Commande `CHECK_DISKSMB`

#### But

Superviser la disponibilité d’un partage réseau SMB accessible depuis le poller (Samba sur Linux).

#### Étapes :

1. Aller dans **Configuration > Commands > Checks**
2. Créer une commande nommée : `CHECK_DISKSMB`
3. Type : `Check`
4. Ligne de commande :

```
$USER1$/check_disk_smb -H $HOSTADDRESS$ -s $_SERVICESMBSHARE$
```

5. Sauvegarder

#### Macro personnalisée à créer dans le service ou modèle :

- `_SERVICESMBSHARE` (valeurs : `admin`, `distrib`)

---

### 📌 Commande `CHECK_DNS`

#### But

Vérifier qu’un serveur DNS répond pour une zone spécifique (locale ou publique).

#### Étapes :

1. Nom : `CHECK_DNS`
2. Ligne de commande :

```
$USER1$/check_dns -H $_SERVICEFQDN$ -s $HOSTADDRESS$
```

3. Type : `Check`
4. Macro personnalisée :

- `_SERVICEFQDN` (ex : `pcp.local`, `pcp.fr`)

---

### 📌 Commande `CHECK_RPC`

#### But

Superviser le service RPC, en particulier l’export NFS actif côté Linux.

#### Étapes :

1. Nom : `CHECK_RPC`
2. Ligne de commande :

```
$USER1$/check_rpc -H $HOSTADDRESS$ -C $_SERVICEPROGRPC$
```

3. Macro :

- `_SERVICEPROGRPC` (valeur : `nfs`)

---

### 📌 Commande `CHECK_HTTP`

#### But

Superviser la disponibilité d’un site web local ou public avec options spécifiques (port, texte attendu, hôte virtuel).

#### Étapes :

1. Nom : `CHECK_HTTP`
2. Ligne de commande :

```
$USER1$/check_http -H $_SERVICEVHOST$ -p $_SERVICEPORT$ -s '$_SERVICESTRING$'
```

3. Macros :

- `_SERVICEVHOST` (ex : `www.pcp.local`, `www.pcp.fr`)
- `_SERVICEPORT` (ex : `80`, `8080`)
- `_SERVICESTRING` (chaîne à rechercher dans la page, ex : `PCP`)

---

### ✔️ Tests CLI avant intégration

Chaque commande doit être testée manuellement depuis le poller :

```
/usr/lib/nagios/plugins/check_dns -H pcp.local -s 192.168.1.11
/usr/lib/nagios/plugins/check_http -H www.pcp.local -p 80 -s 'PCP'
/usr/lib/nagios/plugins/check_rpc -H 192.168.1.12 -C nfs
/usr/lib/nagios/plugins/check_disk_smb -H 192.168.1.12 -s distrib
```

Corriger les droits d'exécution si nécessaire (`chmod +x plugin`) et vérifier les dépendances (`libsmbclient`, `libnet`) sur le poller.

---

## 🔧 Étape 4 – Création des modèles de services (Configuration > Templates > Services)

#### 1. `STF_DISKSMB`

- Nom : `STF_DISKSMB`
- Commande : `CHECK_DISKSMB`
- Hérite de : `STC_DEFAULT`
- Macros à ajouter :
    - `_SERVICESMBSHARE` (valeur à fournir dans le service, ex : `admin`, `distrib`)

#### 2. `STF_DNS`

- Nom : `STF_DNS`
- Commande : `CHECK_DNS`
- Hérite de : `STC_DEFAULT`
- Macros à ajouter :
    - `_SERVICEFQDN` (ex : `pcp.local`, `pcp.fr`)

#### 3. `STF_RPC`

- Nom : `STF_RPC`
- Commande : `CHECK_RPC`
- Hérite de : `STC_DEFAULT`
- Macros à ajouter :
    - `_SERVICEPROGRPC` = `nfs`

#### 4. `STF_HTTP`

- Nom : `STF_HTTP`
- Commande : `CHECK_HTTP`
- Hérite de : `STC_DEFAULT`
- Macros à ajouter :
    - `_SERVICEVHOST` (ex : `www.pcp.local`, `www.pcp.fr`)
    - `_SERVICEPORT` (ex : `80`, `8080`)
    - `_SERVICESTRING` (texte attendu dans le contenu de la page, ex : `PCP`)

---

### 🔗 Association aux hôtes (Configuration > Hosts)

#### A. `ClientPCP-SRVDMZ`

Ajouter les services suivants :

- `S_HTTP-www.pcp.local` → basé sur `STF_HTTP`
    - `_SERVICEVHOST=www.pcp.local`, `_SERVICEPORT=80`, `_SERVICESTRING=PCP`
- `S_DNS-pcp.local` → basé sur `STF_DNS`
    - `_SERVICEFQDN=pcp.local`
- `S_DNS-pcp.fr` → basé sur `STF_DNS`
    - `_SERVICEFQDN=pcp.fr`

#### B. `ClientPCP-SRVFIC`

Ajouter les services suivants :

- `S_SAMBA-distrib` → basé sur `STF_DISKSMB`
    - `_SERVICESMBSHARE=distrib`
- `S_SAMBA-admin` → basé sur `STF_DISKSMB`
    - `_SERVICESMBSHARE=admin`
- `S_NFS` → basé sur `STF_RPC`
    - `_SERVICEPROGRPC=nfs`

#### C. `ClientPCP-FIREWALL`

Ajouter les services suivants :

- `S_HTTP_URL-Pfsense` → basé sur `STF_HTTP`
    - `_SERVICEVHOST=pfsense.pcp.local`, `_SERVICEPORT=8080`, `_SERVICESTRING=Login`
- `S_HTTP-www.pcp.fr` → basé sur `STF_HTTP`
    - `_SERVICEVHOST=www.pcp.fr`, `_SERVICEPORT=80`, `_SERVICESTRING=PCP`

---

## 🚀 Étape 5 – Export de configuration

### 1. Génération de la configuration

- Aller dans **Configuration > Pollers > Generate Configuration**
- Cocher :
    - Le poller `Central` (si hôtes type `pfSense`)
    - Le poller `PollerPCP` (pour les hôtes internes client)
- Cliquer sur **Generate**
- Attendre le retour avec mention **[OK]** dans les logs de génération
- Si erreurs : vérifier l’assignation des hôtes/services, commandes, macros

### 2. Exportation de la configuration

- Depuis le même menu, cliquer sur **Export Configuration**
- Valider l’export pour chaque poller concerné
- Centreon Gorgone transmet la configuration au poller distant via SSH
- Aucun redémarrage manuel requis si Gorgone fonctionne correctement

> 🧪 En cas de doute, tester la connexion SSH avec :

```
su - centreon-gorgone
ssh centreon@192.168.1.10
```

### 3. Vérification dans l’interface de supervision

- Menu : **Monitoring > Status Details > Hosts**
- Vérifier que :
    - Les hôtes apparaissent comme UP
    - Les services sont bien listés pour chaque hôte
    - Les statuts sont cohérents (OK, WARNING, CRITICAL selon état réel)
- Menu : **Monitoring > Status Details > Services**
    - Vérifier l’affichage des macros (VHOST, SHARE, etc.)
    - Cliquer sur un service → **Details** → Voir la ligne de commande réelle exécutée

### 4. Tester une alerte

- Simuler un incident côté client :
    - Arrêter un service (`systemctl stop smbd`, désactiver DNS, etc.)
    - Provoquer un échec de chaîne HTML (changer la page index temporairement)
- Vérifier l’apparition d’un statut CRITICAL ou WARNING côté Centreon

### 5. Journalisation

- Accès aux logs :

```
/var/log/centreon-engine/centengine.log
/var/log/centreon-broker/poller-PollerPCP.log
```

- Rechercher les erreurs de commande, de permission, ou de macros

---

## ⚠️ Remarques

- Le **partage admin** génère un `Access denied` mais cela prouve sa présence → adapter l’interprétation
- Certains services sont **démarrés/arrêtés automatiquement** via `cron` sur les serveurs (scripts `/root/service.sh`, `/root/servicenfs.sh`)
- Éviter les interprétations erronées si les services sont volontairement arrêtés de façon temporaire

---

## ✅ À retenir pour les révisions

- Une architecture distribuée permet de déléguer localement la supervision, tout en centralisant les décisions et la visualisation
- L’échange de clés SSH entre central et poller est indispensable
- Toujours **tester les sondes en CLI** avant intégration Web
- Utiliser des modèles et macros pour créer des sondes **réutilisables pour d’autres clients**

---

## 📌 Bonnes pratiques professionnelles

- Respecter une **convention stricte** dans les noms (STF_, S_, CHECK_, etc.)
- Ne jamais oublier de **générer + exporter** après ajout/modif
- Anticiper les cas où certains services sont absents, protégés, ou désactivés temporairement
- Tester les **scripts cron clients** pour valider les périodes d’inactivité
- Prévoir des **valeurs critiques adaptées** selon le contexte métier