# TP â€“ Supervision distribuÃ©e avec Centreon
## ğŸ§¾ Contexte et architecture

Lâ€™entreprise **PcP (Programmeurs en C Plus-plus)** subit des instabilitÃ©s de service. Votre mission consiste Ã  :

- IntÃ©grer leur poller Centreon Ã  votre infrastructure centrale
- Superviser les services internes critiques : DNS, HTTP, Samba, NFS
- Utiliser Centreon pour configurer une supervision distribuÃ©e stable, Ã©volutive et rÃ©utilisable

### SchÃ©ma logique (machines clientes)

- `ClientPCP-FIREWALL` (pfSense) â€“ IP publique accessible
- `ClientPCP-SRVDMZ` (Web + DNS)
- `ClientPCP-SRVFIC` (Samba + NFS)
- `PollerPCP` â€“ installÃ© dans leur rÃ©seau, accessible en SSH

Compte de maintenance sur les serveurs clients : `presta / Pa$$w0rd`

---

## ğŸ”„ Ã‰tape 1 â€“ Ajout du poller distant (PollerPCP)

### 1. GÃ©nÃ©ration de la clÃ© SSH cÃ´tÃ© central

```bash
su - centreon-gorgone
ssh-keygen -t rsa     # Valider sans passphrase
```

### 2. Copie de la clÃ© vers le poller

```bash
ssh-copy-id centreon@192.168.1.10
```

### 3. VÃ©rification de la connexion

```bash
ssh centreon@192.168.1.10     # Pas de mot de passe demandÃ©
```

### 4. Ajout via lâ€™interface Web

- **Configuration > Pollers > Add Server with wizard**
- Mode de communication : SSH
- VÃ©rifier :
    - Lancement des services
    - RedÃ©marrage du poller (au besoin 2 fois)

### 5. RedÃ©marrer le Gorgone cÃ´tÃ© central

```bash
systemctl restart gorgoned
```

---

## ğŸ§  Ã‰tape 2 â€“ Analyse des services Ã  superviser

|HÃ´te|Superviseur|Services supervisÃ©s|
|---|---|---|
|`SRV-DMZ`|PollerPCP|HTTP sur `www.pcp.local`, DNS `pcp.local` + `pcp.fr`|
|`SRV-FIC`|PollerPCP|Samba (admin, distrib), NFS|
|`pfSensePCP`|Central|HTTP (port 8080), NAT `www.pcp.fr`|

> ğŸ’¡ VÃ©rifier les plugins disponibles : `check_http`, `check_dns`, `check_rpc`, `check_disk_smb`, `check_ping`  
> Si besoin, copier avec `scp` depuis le central

---

## ğŸ› ï¸ Ã‰tape 3 â€“ Commandes de supervision (rÃ©utilisables)
### ğŸ“Œ Commande `CHECK_DISKSMB`

#### But

Superviser la disponibilitÃ© dâ€™un partage rÃ©seau SMB accessible depuis le poller (Samba sur Linux).

#### Ã‰tapes :

1. Aller dans **Configuration > Commands > Checks**
2. CrÃ©er une commande nommÃ©e : `CHECK_DISKSMB`
3. Type : `Check`
4. Ligne de commande :

```
$USER1$/check_disk_smb -H $HOSTADDRESS$ -s $_SERVICESMBSHARE$
```

5. Sauvegarder

#### Macro personnalisÃ©e Ã  crÃ©er dans le service ou modÃ¨le :

- `_SERVICESMBSHARE` (valeurs : `admin`, `distrib`)

---

### ğŸ“Œ Commande `CHECK_DNS`

#### But

VÃ©rifier quâ€™un serveur DNS rÃ©pond pour une zone spÃ©cifique (locale ou publique).

#### Ã‰tapes :

1. Nom : `CHECK_DNS`
2. Ligne de commande :

```
$USER1$/check_dns -H $_SERVICEFQDN$ -s $HOSTADDRESS$
```

3. Type : `Check`
4. Macro personnalisÃ©e :

- `_SERVICEFQDN` (ex : `pcp.local`, `pcp.fr`)

---

### ğŸ“Œ Commande `CHECK_RPC`

#### But

Superviser le service RPC, en particulier lâ€™export NFS actif cÃ´tÃ© Linux.

#### Ã‰tapes :

1. Nom : `CHECK_RPC`
2. Ligne de commande :

```
$USER1$/check_rpc -H $HOSTADDRESS$ -C $_SERVICEPROGRPC$
```

3. Macro :

- `_SERVICEPROGRPC` (valeur : `nfs`)

---

### ğŸ“Œ Commande `CHECK_HTTP`

#### But

Superviser la disponibilitÃ© dâ€™un site web local ou public avec options spÃ©cifiques (port, texte attendu, hÃ´te virtuel).

#### Ã‰tapes :

1. Nom : `CHECK_HTTP`
2. Ligne de commande :

```
$USER1$/check_http -H $_SERVICEVHOST$ -p $_SERVICEPORT$ -s '$_SERVICESTRING$'
```

3. Macros :

- `_SERVICEVHOST` (ex : `www.pcp.local`, `www.pcp.fr`)
- `_SERVICEPORT` (ex : `80`, `8080`)
- `_SERVICESTRING` (chaÃ®ne Ã  rechercher dans la page, ex : `PCP`)

---

### âœ”ï¸ Tests CLI avant intÃ©gration

Chaque commande doit Ãªtre testÃ©e manuellement depuis le poller :

```
/usr/lib/nagios/plugins/check_dns -H pcp.local -s 192.168.1.11
/usr/lib/nagios/plugins/check_http -H www.pcp.local -p 80 -s 'PCP'
/usr/lib/nagios/plugins/check_rpc -H 192.168.1.12 -C nfs
/usr/lib/nagios/plugins/check_disk_smb -H 192.168.1.12 -s distrib
```

Corriger les droits d'exÃ©cution si nÃ©cessaire (`chmod +x plugin`) et vÃ©rifier les dÃ©pendances (`libsmbclient`, `libnet`) sur le poller.

---

## ğŸ”§ Ã‰tape 4 â€“ CrÃ©ation des modÃ¨les de services (Configuration > Templates > Services)

#### 1. `STF_DISKSMB`

- Nom : `STF_DISKSMB`
- Commande : `CHECK_DISKSMB`
- HÃ©rite de : `STC_DEFAULT`
- Macros Ã  ajouter :
    - `_SERVICESMBSHARE` (valeur Ã  fournir dans le service, ex : `admin`, `distrib`)

#### 2. `STF_DNS`

- Nom : `STF_DNS`
- Commande : `CHECK_DNS`
- HÃ©rite de : `STC_DEFAULT`
- Macros Ã  ajouter :
    - `_SERVICEFQDN` (ex : `pcp.local`, `pcp.fr`)

#### 3. `STF_RPC`

- Nom : `STF_RPC`
- Commande : `CHECK_RPC`
- HÃ©rite de : `STC_DEFAULT`
- Macros Ã  ajouter :
    - `_SERVICEPROGRPC` = `nfs`

#### 4. `STF_HTTP`

- Nom : `STF_HTTP`
- Commande : `CHECK_HTTP`
- HÃ©rite de : `STC_DEFAULT`
- Macros Ã  ajouter :
    - `_SERVICEVHOST` (ex : `www.pcp.local`, `www.pcp.fr`)
    - `_SERVICEPORT` (ex : `80`, `8080`)
    - `_SERVICESTRING` (texte attendu dans le contenu de la page, ex : `PCP`)

---

### ğŸ”— Association aux hÃ´tes (Configuration > Hosts)

#### A. `ClientPCP-SRVDMZ`

Ajouter les services suivants :

- `S_HTTP-www.pcp.local` â†’ basÃ© sur `STF_HTTP`
    - `_SERVICEVHOST=www.pcp.local`, `_SERVICEPORT=80`, `_SERVICESTRING=PCP`
- `S_DNS-pcp.local` â†’ basÃ© sur `STF_DNS`
    - `_SERVICEFQDN=pcp.local`
- `S_DNS-pcp.fr` â†’ basÃ© sur `STF_DNS`
    - `_SERVICEFQDN=pcp.fr`

#### B. `ClientPCP-SRVFIC`

Ajouter les services suivants :

- `S_SAMBA-distrib` â†’ basÃ© sur `STF_DISKSMB`
    - `_SERVICESMBSHARE=distrib`
- `S_SAMBA-admin` â†’ basÃ© sur `STF_DISKSMB`
    - `_SERVICESMBSHARE=admin`
- `S_NFS` â†’ basÃ© sur `STF_RPC`
    - `_SERVICEPROGRPC=nfs`

#### C. `ClientPCP-FIREWALL`

Ajouter les services suivants :

- `S_HTTP_URL-Pfsense` â†’ basÃ© sur `STF_HTTP`
    - `_SERVICEVHOST=pfsense.pcp.local`, `_SERVICEPORT=8080`, `_SERVICESTRING=Login`
- `S_HTTP-www.pcp.fr` â†’ basÃ© sur `STF_HTTP`
    - `_SERVICEVHOST=www.pcp.fr`, `_SERVICEPORT=80`, `_SERVICESTRING=PCP`

---

## ğŸš€ Ã‰tape 5 â€“ Export de configuration

### 1. GÃ©nÃ©ration de la configuration

- Aller dans **Configuration > Pollers > Generate Configuration**
- Cocher :
    - Le poller `Central` (si hÃ´tes type `pfSense`)
    - Le poller `PollerPCP` (pour les hÃ´tes internes client)
- Cliquer sur **Generate**
- Attendre le retour avec mention **[OK]** dans les logs de gÃ©nÃ©ration
- Si erreurs : vÃ©rifier lâ€™assignation des hÃ´tes/services, commandes, macros

### 2. Exportation de la configuration

- Depuis le mÃªme menu, cliquer sur **Export Configuration**
- Valider lâ€™export pour chaque poller concernÃ©
- Centreon Gorgone transmet la configuration au poller distant via SSH
- Aucun redÃ©marrage manuel requis si Gorgone fonctionne correctement

> ğŸ§ª En cas de doute, tester la connexion SSH avec :

```
su - centreon-gorgone
ssh centreon@192.168.1.10
```

### 3. VÃ©rification dans lâ€™interface de supervision

- Menu : **Monitoring > Status Details > Hosts**
- VÃ©rifier que :
    - Les hÃ´tes apparaissent comme UP
    - Les services sont bien listÃ©s pour chaque hÃ´te
    - Les statuts sont cohÃ©rents (OK, WARNING, CRITICAL selon Ã©tat rÃ©el)
- Menu : **Monitoring > Status Details > Services**
    - VÃ©rifier lâ€™affichage des macros (VHOST, SHARE, etc.)
    - Cliquer sur un service â†’ **Details** â†’ Voir la ligne de commande rÃ©elle exÃ©cutÃ©e

### 4. Tester une alerte

- Simuler un incident cÃ´tÃ© client :
    - ArrÃªter un service (`systemctl stop smbd`, dÃ©sactiver DNS, etc.)
    - Provoquer un Ã©chec de chaÃ®ne HTML (changer la page index temporairement)
- VÃ©rifier lâ€™apparition dâ€™un statut CRITICAL ou WARNING cÃ´tÃ© Centreon

### 5. Journalisation

- AccÃ¨s aux logs :

```
/var/log/centreon-engine/centengine.log
/var/log/centreon-broker/poller-PollerPCP.log
```

- Rechercher les erreurs de commande, de permission, ou de macros

---

## âš ï¸ Remarques

- Le **partage admin** gÃ©nÃ¨re un `Access denied` mais cela prouve sa prÃ©sence â†’ adapter lâ€™interprÃ©tation
- Certains services sont **dÃ©marrÃ©s/arrÃªtÃ©s automatiquement** via `cron` sur les serveurs (scripts `/root/service.sh`, `/root/servicenfs.sh`)
- Ã‰viter les interprÃ©tations erronÃ©es si les services sont volontairement arrÃªtÃ©s de faÃ§on temporaire

---

## âœ… Ã€ retenir pour les rÃ©visions

- Une architecture distribuÃ©e permet de dÃ©lÃ©guer localement la supervision, tout en centralisant les dÃ©cisions et la visualisation
- Lâ€™Ã©change de clÃ©s SSH entre central et poller est indispensable
- Toujours **tester les sondes en CLI** avant intÃ©gration Web
- Utiliser des modÃ¨les et macros pour crÃ©er des sondes **rÃ©utilisables pour dâ€™autres clients**

---

## ğŸ“Œ Bonnes pratiques professionnelles

- Respecter une **convention stricte** dans les noms (STF_, S_, CHECK_, etc.)
- Ne jamais oublier de **gÃ©nÃ©rer + exporter** aprÃ¨s ajout/modif
- Anticiper les cas oÃ¹ certains services sont absents, protÃ©gÃ©s, ou dÃ©sactivÃ©s temporairement
- Tester les **scripts cron clients** pour valider les pÃ©riodes dâ€™inactivitÃ©
- PrÃ©voir des **valeurs critiques adaptÃ©es** selon le contexte mÃ©tier