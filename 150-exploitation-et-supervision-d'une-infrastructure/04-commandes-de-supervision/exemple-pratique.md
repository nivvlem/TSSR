# TP â€“ Sondes personnalisÃ©es : tests avec plugins NRPE, SNMP et ping

## ðŸ§¾ PrÃ©requis

- Centreon installÃ© et fonctionnel (avec accÃ¨s aux plugins)
- Un poste Windows et un poste Linux supervisÃ©s
- AccÃ¨s root/centreon-engine sur le superviseur
- Plugins SNMP, NRPE et classiques installÃ©s sur Centreon

---

## ðŸ“‚ Emplacements des sondes (commandes)

- `/usr/lib64/nagios/plugins` : plugins historiques Nagios (check_ping, check_httpâ€¦)
- `/usr/lib/nagios/plugins` : commandes pour NRPE
- `/usr/lib/centreon/plugins` : plugins Centreon (SNMP, spÃ©cifiques)

**Toutes les commandes doivent Ãªtre exÃ©cutÃ©es avec lâ€™utilisateur `centreon-engine` pour simuler un appel rÃ©el.**

```bash
su - centreon-engine -s /bin/bash
```

---

## ðŸ” Ã‰tape 1 â€“ Commande de supervision : test de connectivitÃ© (ping)

Commande utilisÃ©e : `check_ping`

```bash
/usr/lib64/nagios/plugins/check_ping -H 172.16.1.101 -p 5 -w 3,20% -c 5,60%
```

Explication :

- `-H` : IP cible (172.16.1.101)
- `-p` : nombre de paquets ICMP envoyÃ©s (5)
- `-w` : seuil warning = dÃ©lai > 3ms ou perte > 20%
- `-c` : seuil critique = dÃ©lai > 5ms ou perte > 60%

---

## ðŸªŸ Ã‰tape 2 â€“ Supervision NRPE sur poste Windows

### Configuration prÃ©alable

- NSClient++ doit Ãªtre installÃ© avec support NRPE activÃ©
- Centreon doit avoir accÃ¨s au port TCP 5666

### Commande 1 â€“ VÃ©rification de la charge CPU

```bash
/usr/lib/nagios/plugins/check_centreon_nrpe3 -H 172.16.1.100 -c check_cpu -a "warn=load > 70" "crit=load > 85"
```

### Commande 2 â€“ VÃ©rification de la mÃ©moire physique

```bash
/usr/lib/nagios/plugins/check_centreon_nrpe3 -H 172.16.1.100 -c check_memory -a "warn=used > 75%" "crit=used > 90%" "type=physical"
```

### Commande 3 â€“ VÃ©rification espace disque (C:)

```bash
/usr/lib/nagios/plugins/check_centreon_nrpe3 -H 172.16.1.100 -c check_drivesize -a "drive=c:" "crit=free < 5G" "warn=free < 15G"
```

---

## ðŸ§ Ã‰tape 3 â€“ Supervision SNMP sur poste Linux (Debian)

### PrÃ©paration

- Le service SNMP doit Ãªtre installÃ© et configurÃ© sur l'hÃ´te cible (snmpd)
- Centreon doit avoir accÃ¨s sur le port UDP 161

### Commande 1 â€“ Supervision CPU

```bash
/usr/lib/centreon/plugins/centreon_linux_snmp.pl --plugin=os::linux::snmp::plugin --mode=cpu --hostname=172.16.1.101 --snmp-community=sniper --snmp-version=2 --warning-average=70 --critical-average=85
```

### Commande 2 â€“ Supervision mÃ©moire

```bash
/usr/lib/centreon/plugins/centreon_linux_snmp.pl --plugin=os::linux::snmp::plugin --mode=memory --hostname=172.16.1.101 --snmp-community=sniper --snmp-version=2 --warning-usage-prct=75 --critical-usage-prct=90
```

### Commande 3 â€“ Supervision espace disque `/` et `/usr`

```bash
/usr/lib/centreon/plugins/centreon_linux_snmp.pl --plugin=os::linux::snmp::plugin --mode=storage --hostname=172.16.1.101 --snmp-community=sniper --snmp-version=2 --name --storage='/' --warning-usage=60 --critical-usage=80

/usr/lib/centreon/plugins/centreon_linux_snmp.pl --plugin=os::linux::snmp::plugin --mode=storage --hostname=172.16.1.101 --snmp-community=sniper --snmp-version=2 --name --storage='/usr' --warning-usage=60 --critical-usage=80
```

---

## ðŸ§ª Ã‰tape 4 â€“ Test en ligne de commande

### Test de sortie de commande

```bash
echo $?
```

- `0` â†’ OK
- `1` â†’ WARNING
- `2` â†’ CRITICAL
- `3` â†’ UNKNOWN

---

## âœ… Ã€ retenir pour les rÃ©visions

- Une **commande de supervision** est un script ou binaire qui retourne un **code + message**
- Elle peut Ãªtre locale (plugin Nagios), distante (NRPE) ou via SNMP
- Toujours **tester en ligne de commande** avant d'intÃ©grer Ã  l'interface Web

---

## ðŸ“Œ Bonnes pratiques professionnelles

- Documenter **chaque commande testÃ©e** (IP cible, plugin, paramÃ¨tres)
- Ã‰viter la supervision SNMP avec la communautÃ© `public`
- Regrouper les commandes par type pour simplifier la maintenance
- VÃ©rifier que l'utilisateur `centreon-engine` peut exÃ©cuter tous les plugins
- RÃ©aliser les tests avec seuils cohÃ©rents avec la charge rÃ©elle des systÃ¨mes