# TP – Sondes personnalisées : tests avec plugins NRPE, SNMP et ping

## 🧾 Prérequis

- Centreon installé et fonctionnel (avec accès aux plugins)
- Un poste Windows et un poste Linux supervisés
- Accès root/centreon-engine sur le superviseur
- Plugins SNMP, NRPE et classiques installés sur Centreon

---

## 📂 Emplacements des sondes (commandes)

- `/usr/lib64/nagios/plugins` : plugins historiques Nagios (check_ping, check_http…)
- `/usr/lib/nagios/plugins` : commandes pour NRPE
- `/usr/lib/centreon/plugins` : plugins Centreon (SNMP, spécifiques)

**Toutes les commandes doivent être exécutées avec l’utilisateur `centreon-engine` pour simuler un appel réel.**

```bash
su - centreon-engine -s /bin/bash
```

---

## 🔍 Étape 1 – Commande de supervision : test de connectivité (ping)

Commande utilisée : `check_ping`

```bash
/usr/lib64/nagios/plugins/check_ping -H 172.16.1.101 -p 5 -w 3,20% -c 5,60%
```

Explication :

- `-H` : IP cible (172.16.1.101)
- `-p` : nombre de paquets ICMP envoyés (5)
- `-w` : seuil warning = délai > 3ms ou perte > 20%
- `-c` : seuil critique = délai > 5ms ou perte > 60%

---

## 🪟 Étape 2 – Supervision NRPE sur poste Windows

### Configuration préalable

- NSClient++ doit être installé avec support NRPE activé
- Centreon doit avoir accès au port TCP 5666

### Commande 1 – Vérification de la charge CPU

```bash
/usr/lib/nagios/plugins/check_centreon_nrpe3 -H 172.16.1.100 -c check_cpu -a "warn=load > 70" "crit=load > 85"
```

### Commande 2 – Vérification de la mémoire physique

```bash
/usr/lib/nagios/plugins/check_centreon_nrpe3 -H 172.16.1.100 -c check_memory -a "warn=used > 75%" "crit=used > 90%" "type=physical"
```

### Commande 3 – Vérification espace disque (C:)

```bash
/usr/lib/nagios/plugins/check_centreon_nrpe3 -H 172.16.1.100 -c check_drivesize -a "drive=c:" "crit=free < 5G" "warn=free < 15G"
```

---

## 🐧 Étape 3 – Supervision SNMP sur poste Linux (Debian)

### Préparation

- Le service SNMP doit être installé et configuré sur l'hôte cible (snmpd)
- Centreon doit avoir accès sur le port UDP 161

### Commande 1 – Supervision CPU

```bash
/usr/lib/centreon/plugins/centreon_linux_snmp.pl --plugin=os::linux::snmp::plugin --mode=cpu --hostname=172.16.1.101 --snmp-community=sniper --snmp-version=2 --warning-average=70 --critical-average=85
```

### Commande 2 – Supervision mémoire

```bash
/usr/lib/centreon/plugins/centreon_linux_snmp.pl --plugin=os::linux::snmp::plugin --mode=memory --hostname=172.16.1.101 --snmp-community=sniper --snmp-version=2 --warning-usage-prct=75 --critical-usage-prct=90
```

### Commande 3 – Supervision espace disque `/` et `/usr`

```bash
/usr/lib/centreon/plugins/centreon_linux_snmp.pl --plugin=os::linux::snmp::plugin --mode=storage --hostname=172.16.1.101 --snmp-community=sniper --snmp-version=2 --name --storage='/' --warning-usage=60 --critical-usage=80

/usr/lib/centreon/plugins/centreon_linux_snmp.pl --plugin=os::linux::snmp::plugin --mode=storage --hostname=172.16.1.101 --snmp-community=sniper --snmp-version=2 --name --storage='/usr' --warning-usage=60 --critical-usage=80
```

---

## 🧪 Étape 4 – Test en ligne de commande

### Test de sortie de commande

```bash
echo $?
```

- `0` → OK
- `1` → WARNING
- `2` → CRITICAL
- `3` → UNKNOWN

---

## ✅ À retenir pour les révisions

- Une **commande de supervision** est un script ou binaire qui retourne un **code + message**
- Elle peut être locale (plugin Nagios), distante (NRPE) ou via SNMP
- Toujours **tester en ligne de commande** avant d'intégrer à l'interface Web

---

## 📌 Bonnes pratiques professionnelles

- Documenter **chaque commande testée** (IP cible, plugin, paramètres)
- Éviter la supervision SNMP avec la communauté `public`
- Regrouper les commandes par type pour simplifier la maintenance
- Vérifier que l'utilisateur `centreon-engine` peut exécuter tous les plugins
- Réaliser les tests avec seuils cohérents avec la charge réelle des systèmes