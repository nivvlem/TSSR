# TP ‚Äì Centreon : Notifications et actions d‚Äôexploitation
## üßæ Pr√©requis

- Disposer d‚Äôun acc√®s administrateur √† Centreon : `http://centreon.sniper.lunette` (admin / secret)
- Machines Windows 10 et Debian fonctionnelles, avec SNMP ou NRPE

---

## üîß √âtapes de configuration

### 1. Cr√©ation des commandes de supervision

Cr√©er les commandes suivantes dans Centreon (**Configuration > Commands > Checks**) en utilisant les chemins standardis√©s `$CENTREONPLUGINS$`, les macros personnalis√©es, et une convention de nommage claire.

#### `CHECK_CPU_WINDOWS` (SNMP)

```bash
$CENTREONPLUGINS$/centreon_windows_snmp.pl \
--plugin=os::windows::snmp::plugin \
--mode=cpu \
--hostname=$HOSTADDRESS$ \
--snmp-community=$_HOSTSNMPCOMMUNITY$ \
--snmp-version=$_HOSTSNMPVERSION$ \
--warning-average=$_SERVICEWARNING$ \
--critical-average=$_SERVICECRITIQUE$
```

#### `CHECK_MEMORY_WINDOWS` (SNMP)

```bash
$CENTREONPLUGINS$/centreon_windows_snmp.pl \
--plugin=os::windows::snmp::plugin \
--mode=memory \
--hostname=$HOSTADDRESS$ \
--snmp-community=$_HOSTSNMPCOMMUNITY$ \
--snmp-version=$_HOSTSNMPVERSION$ \
--warning-usage-prct=$_SERVICEWARNING$ \
--critical-usage-prct=$_SERVICECRITIQUE$
```

#### `CHECK_STORAGE_C_WINDOWS` (NRPE)

```bash
$CENTREONPLUGINS$/centreon_nrpe3 --plugin-name=check_centreon_nrpe3 \
-H $HOSTADDRESS$ -c check_drivesize \
-a "drive=c:" "crit=free < $_SERVICECRITIQUE$" "warn=free < $_SERVICEWARNING$"
```

#### `CHECK_CPU_LINUX` (SNMP)

```bash
$CENTREONPLUGINS$/centreon_linux_snmp.pl \
--plugin=os::linux::snmp::plugin \
--mode=cpu \
--hostname=$HOSTADDRESS$ \
--snmp-community=$_HOSTSNMPCOMMUNITY$ \
--snmp-version=$_HOSTSNMPVERSION$ \
--warning-average=$_SERVICEWARNING$ \
--critical-average=$_SERVICECRITIQUE$
```

#### `CHECK_MEMORY_LINUX` (SNMP)

```bash
$CENTREONPLUGINS$/centreon_linux_snmp.pl \
--plugin=os::linux::snmp::plugin \
--mode=memory \
--hostname=$HOSTADDRESS$ \
--snmp-community=$_HOSTSNMPCOMMUNITY$ \
--snmp-version=$_HOSTSNMPVERSION$ \
--warning-usage-prct=$_SERVICEWARNING$ \
--critical-usage-prct=$_SERVICECRITIQUE$
```

#### `CHECK_STORAGE_HOME_LINUX` (SNMP)

```bash
$CENTREONPLUGINS$/centreon_linux_snmp.pl \
--plugin=os::linux::snmp::plugin \
--mode=storage \
--hostname=$HOSTADDRESS$ \
--snmp-community=$_HOSTSNMPCOMMUNITY$ \
--snmp-version=$_HOSTSNMPVERSION$ \
--name --storage='/home' \
--warning-usage=$_SERVICEWARNING$ --critical-usage=$_SERVICECRITIQUE$
```

#### `Check_Host_Alive` (ping)

```bash
$USER1$/check_ping -H $HOSTADDRESS$ -p 1 -w 4000,80% -c 8000,100%
```

> üí° Tester chaque commande en ligne de commande (CLI) avant int√©gration.

---

### 2. Cr√©ation des mod√®les de services (Configuration > Templates > Services)

#### Objectif

Cr√©er des mod√®les de services r√©utilisables, bas√©s sur les commandes cr√©√©es pr√©c√©demment, et les organiser de fa√ßon modulaire.

#### √âtapes d√©taill√©es

1. Aller dans **Configuration > Templates > Services**
2. Cr√©er un mod√®le de base : `STC_DEFAULT`
    - Nom : `STC_DEFAULT`
    - Intervalle de check : 5 min
    - Tentatives avant passage HARD : 3
    - Notifications activ√©es : oui
    - P√©riode : 24x7
3. Cr√©er les mod√®les fonctionnels (h√©ritant de `STC_DEFAULT`) :

##### `STF_WINDOWS_CPU`

- Mod√®le : h√©rite de `STC_DEFAULT`
- Commande : `CHECK_CPU_WINDOWS`
- Macros :
    - `_SERVICEWARNING` = `80`
    - `_SERVICECRITIQUE` = `90`

##### `STF_WINDOWS_MEMORY`

- Mod√®le : h√©rite de `STC_DEFAULT`
- Commande : `CHECK_MEMORY_WINDOWS`
- Macros :
    - `_SERVICEWARNING` = `80`
    - `_SERVICECRITIQUE` = `90`

##### `STF_WINDOWS_STORAGE_C`

- Mod√®le : h√©rite de `STC_DEFAULT`
- Commande : `CHECK_STORAGE_C_WINDOWS`
- Macros :
    - `_SERVICEWARNING` = `15G`
    - `_SERVICECRITIQUE` = `5G`
    - `_STORAGE` = `c:`

##### `STF_LINUX_CPU`

- Mod√®le : h√©rite de `STC_DEFAULT`
- Commande : `CHECK_CPU_LINUX`
- Macros :
    - `_SERVICEWARNING` = `70`
    - `_SERVICECRITIQUE` = `85`

##### `STF_LINUX_MEMORY`

- Mod√®le : h√©rite de `STC_DEFAULT`
- Commande : `CHECK_MEMORY_LINUX`
- Macros :
    - `_SERVICEWARNING` = `75`
    - `_SERVICECRITIQUE` = `90`

##### `STF_LINUX_STORAGE_HOME`

- Mod√®le : h√©rite de `STC_DEFAULT`
- Commande : `CHECK_STORAGE_HOME_LINUX`
- Macros :
    - `_SERVICEWARNING` = `60`
    - `_SERVICECRITIQUE` = `80`
    - `_STORAGE` = `/home`

> üí° Utiliser les macros personnalis√©es permet d‚Äôadapter chaque service sans cr√©er de doublon inutile.

---

### 3. Cr√©ation des mod√®les d‚Äôh√¥tes

#### Objectif

Structurer les mod√®les d‚Äôh√¥tes pour centraliser les param√®tres et appliquer automatiquement les services.

#### √âtapes d√©taill√©es

1. Aller dans **Configuration > Templates > Hosts**
2. Cr√©er un mod√®le g√©n√©ral `HTC_DEFAULT` :
    - SNMP activ√©, version 2c
    - Communaut√© SNMP : `sniper`
    - P√©riode : 24x7
    - Check every : 5 min
3. Cr√©er les mod√®les fonctionnels :

##### `HTF_WINDOWS`

- H√©rite de `HTC_DEFAULT`
- Services associ√©s : `STF_WINDOWS_CPU`, `STF_WINDOWS_MEMORY`, `STF_WINDOWS_STORAGE_C`

##### `HTF_LINUX`

- H√©rite de `HTC_DEFAULT`
- Services associ√©s : `STF_LINUX_CPU`, `STF_LINUX_MEMORY`, `STF_LINUX_STORAGE_HOME`

4. Ajouter dans `HTC_DEFAULT` (ou h√¥te) les macros personnalis√©es :
    - `_HOSTSNMPVERSION` = `2`
    - `_HOSTSNMPCOMMUNITY` = `sniper`

---

### 4. Cr√©ation des h√¥tes supervis√©s (Configuration > Hosts)

#### √âtapes d√©taill√©es

1. Aller dans **Configuration > Hosts**
2. Ajouter l‚Äôh√¥te Windows `H_WINDOWS`
    - Nom : `H_WINDOWS`
    - IP : `172.16.1.100`
    - Mod√®le : `HTF_WINDOWS`
    - V√©rifier h√©ritage des macros SNMP
3. Ajouter l‚Äôh√¥te Linux `H_LINUX`
    - Nom : `H_LINUX`
    - IP : `172.16.1.101`
    - Mod√®le : `HTF_LINUX`
4. Tester connectivit√© depuis Centreon :

```bash
ping 172.16.1.100
snmpwalk -v2c -c sniper 172.16.1.101
```

---

### 5. G√©n√©ration et export de la configuration

1. Menu **Configuration > Pollers > Generate Configuration**
2. S√©lectionner le poller (Central) ‚Üí cliquer sur **G√©n√©rer**
3. Lire les messages, corriger les √©ventuelles erreurs
4. Cliquer sur **Exporter**
5. Red√©marrer le moteur si besoin :

```bash
systemctl restart centreon-engine
```

> üîÑ R√©g√©n√©rer syst√©matiquement apr√®s chaque modification de template ou h√¥te
---

## üì£ Notifications (Configuration > Contacts)

- Cr√©er un contact (ex : pr√©nom)
- Adresse mail : `user01@sniper.lunette`
- Notifications : toutes activ√©es, p√©riode 24x7
- Associer aux mod√®les h√¥te et service (HTC/STC)

Tester l‚Äôenvoi de mail via `http://webmail.sniper.lunette` (login : `user01`, mdp : `Pa$$w0rd`)

---

## üí• Simulation d‚Äôalertes

- **Linux** : `dd` pour disque, `stress-ng` pour CPU
- **Windows** : `fsutil` pour disque, `LoadStorm` ou boucle PowerShell pour CPU

---

## ‚úÖ √Ä retenir pour les r√©visions

- Chaque commande doit utiliser **macros + arguments personnalisables**
- Tester chaque sonde **en CLI avant de l‚Äôint√©grer √† Centreon**
- G√©n√©rer, v√©rifier, exporter la configuration apr√®s toute modification

---

## üìå Bonnes pratiques professionnelles

- Centraliser les commandes dans un fichier de documentation
- Suivre une **convention stricte de nommage** (CHECK_, STF_, HTC_...)
- Documenter les seuils et macros utilis√©es
- V√©rifier manuellement la livraison d‚Äôemail apr√®s incident
- Nettoyer les fichiers temporaires utilis√©s lors des simulations (dd, fsutil, etc.)