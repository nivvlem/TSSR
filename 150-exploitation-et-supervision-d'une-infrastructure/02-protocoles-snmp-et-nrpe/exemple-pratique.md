# TP ‚Äì Supervision SNMP et NRPE avec Centreon

## üßæ Environnement et pr√©requis

- R√©seau VMnet14
- 3 VMs :
    - `Centreon-central` (Superviseur) ‚Äì root / Pa$5w0rd
    - `Srv-mail` (DNS/messagerie) ‚Äì md / Pa$5w0rd
    - `PfSenseSniper` (pas de compte requis)
- D√©ploiement de 2 nouveaux clients : **Windows 10** et **Debian 12**
- Domaine : `sniper.lunette`

---

## üíª Installation et configuration client Windows 10

### 1. Pr√©paration

- D√©ployer la VM Windows 10 (2Go RAM, 1 vCPU)
- R√©seau VMnet14
- Ajouter le suffixe DNS `sniper.lunette` dans les propri√©t√©s r√©seau
- V√©rifier :

```powershell
ping webmail
```

### 2. Installer SNMP

```powershell
Add-WindowsCapability -Name "SNMP.Client~~~~0.0.1.0" -Online
Restart-Computer
```

### 3. Configurer SNMP via PowerShell (en admin)

```powershell
# Autoriser Centreon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SNMP\Parameters\PermittedManagers" -Name "2" -Value "172.16.1.10"

# Cr√©er la communaut√© en lecture seule
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SNMP\Parameters\ValidCommunities" -Name "sniper" -Value 4 -type DWord

# D√©finir l'agent
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SNMP\Parameters\RFC1156Agent" -Name "sysLocation" -Value "172.16.1.10"
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SNMP\Parameters\RFC1156Agent" -Name "sysContact" -Value "centreon-engine"

Restart-Service SNMP
```

### 4. Installer NSClient++ (NRPE)

- T√©l√©charger depuis [https://www.nsclient.org](https://www.nsclient.org/)
- Mode Insecure / NRPE actif
- D√©finir un mot de passe s√©curis√©
- Autoriser les connexions depuis Centreon
- Activer les modules de supervision (ex : `check_cpu`)

### 5. Tester localement (NSClient++)

- V√©rifier la bonne ex√©cution du plugin CPU en local

---

## üêß Installation et configuration client Debian 12

### 1. Installation syst√®me

- Version : Debian NetInstall
- 1Go RAM, 1 vCPU, 20Go disque
- Partitions :
    - / (8Go) ‚Äì ext4
    - /usr (8Go) ‚Äì ext4
    - swap (1Go)
    - /home (reste) ‚Äì ext4
- R√©seau : Bridged sur VMnet14

### 2. Adresse IP statique

```
IP     : 172.16.1.101/24
GW     : 172.16.1.254
DNS    : 172.16.1.20
Domaine: sniper.lunette
```

### 3. Installer SNMP

```bash
apt update && apt install snmpd snmp
```

### 4. Configurer SNMP (/etc/snmp/snmpd.conf)

```bash
agentAddress udp:161
com2sec centreon-sniper 172.16.1.10 sniper

# D√©finir les vues de supervision
view tp1 included .1.3.6.1.2.1.25.3       # CPU
view tp1 included .1.3.6.1.4.1.2021.10    # CPU load
view tp1 included .1.3.6.1.4.1.2021.4     # RAM
view tp1 included .1.3.6.1.2.1.25.2.1     # Disques
view tp1 included .1.3.6.1.2.1.25.2.3     # Disques

group mygroup v2c centreon-sniper
access mygroup "" any noauth exact tp1 none none
```

```bash
systemctl restart snmpd
```

---

## üîç Tests de supervision depuis Centreon

### 1. V√©rification SNMP

```bash
snmpwalk -v2c -c sniper 172.16.1.101
snmpget -v2c -c sniper 172.16.1.100 1.3.6.1.2.1.25.3.3.1.2.196608   # Exemple OID CPU
```

- Tester Windows et Debian

### 2. V√©rification NRPE (Windows uniquement)

```bash
/usr/lib/centreon/plugins/centreon_nrpe3 --plugin-name check_centreon_nrpe3 -H 172.16.1.100 -p 5666 -c check_cpu -a warn=70 crit=90
```

---

## ‚úÖ √Ä retenir pour les r√©visions

- SNMP v2c est simple √† configurer mais **non chiffr√©** ‚ûú filtrer par IP
- NRPE permet des **checks actifs plus pr√©cis** sur services Windows/Linux
- Windows ne prend pas en charge SNMPv3 ‚ûú utiliser des ACLs
- NSClient++ est l‚Äôoutil standard pour NRPE c√¥t√© Windows
- Utiliser des OID cibl√©s pour limiter l‚Äôexposition inutile

---

## üìå Bonnes pratiques professionnelles

- Toujours restreindre les IP autoris√©es √† interroger SNMP
- Changer la communaut√© par d√©faut (`public`) par une cha√Æne forte (`sniper`)
- Documenter les OID utilis√©s (fiche technique, MIB fabricant)
- Tester localement (snmpwalk/snmpget) avant int√©gration dans Centreon
- Mettre √† jour r√©guli√®rement NSClient++ et SNMPD pour corriger failles